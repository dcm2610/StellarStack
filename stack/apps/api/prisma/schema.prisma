generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Better Auth Tables
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  role          String    @default("user")
  banned        Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions Session[]
  accounts Account[]
  servers  Server[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verifications")
}

// ============================================
// Application Tables
// ============================================

enum NodeProtocol {
  HTTP
  HTTPS
  HTTPS_PROXY
}

model Location {
  id          String   @id @default(cuid())
  name        String
  description String?
  country     String?
  city        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  nodes Node[]

  @@map("locations")
}

model Node {
  id            String       @id @default(cuid())
  displayName   String
  host          String
  port          Int
  protocol      NodeProtocol @default(HTTP)
  sftpPort      Int          @default(2022)

  // Resource limits for this node
  memoryLimit   BigInt       // Total memory in bytes
  diskLimit     BigInt       // Total disk in bytes
  cpuLimit      Float        // Total CPU cores
  uploadLimit   BigInt       @default(104857600) // File upload limit in bytes (default 100MB)

  // Authentication
  token         String       @unique
  tokenHash     String
  isOnline      Boolean      @default(false)
  lastHeartbeat DateTime?
  heartbeatLatency Int?      // Last heartbeat latency in ms

  // Relations
  locationId    String
  location      Location     @relation(fields: [locationId], references: [id], onDelete: Cascade)

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  allocations Allocation[]
  servers     Server[]

  @@map("nodes")
}

model Allocation {
  id        String   @id @default(cuid())
  ip        String
  port      Int
  alias     String?
  assigned  Boolean  @default(false)

  nodeId    String
  node      Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  serverId  String?
  server    Server?  @relation(fields: [serverId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([nodeId, ip, port])
  @@map("allocations")
}

model Blueprint {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String?
  author      String?

  // Docker image info (primary image)
  imageName   String
  imageTag    String   @default("latest")
  registry    String?

  // Multiple docker images with labels (Pterodactyl compatibility)
  // Format: { "Java 8": "ghcr.io/image:java_8", "Java 11": "ghcr.io/image:java_11" }
  dockerImages Json?

  // Startup configuration
  startup       String?   // Startup command template (e.g., "java -Xmx{{SERVER_MEMORY}}M -jar server.jar")
  stopCommand   String?   // Command to stop server (e.g., "stop")

  // File configuration parsers (Pterodactyl format)
  // Format: { "server.properties": { "parser": "properties", "find": {...} } }
  configFiles   Json?

  // Startup detection (when server is "done" starting)
  // Format: { "done": "For help, type" }
  startupDetection Json?

  // Installation script
  installScript    String?   @db.Text
  installContainer String?   // Container for installation (e.g., "alpine")
  installEntrypoint String?  // Entrypoint for install (e.g., "ash")

  // Server variables (user-configurable)
  // Format: [{ "name": "...", "env_variable": "...", "default_value": "...", "user_viewable": true, ... }]
  variables     Json?

  // Features (e.g., ["eula", "java_version", "pid_limit"])
  features      Json?

  // Default container configuration (JSON)
  config      Json

  // Visibility
  isPublic    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  servers Server[]

  @@map("blueprints")
}

model Server {
  id           String   @id @default(uuid())
  shortId      String?  // First section of UUID (auto-populated by API)
  name         String
  description  String?

  // Docker container info
  containerId  String?
  status       ServerStatus @default(INSTALLING)

  // Resource allocation
  memory       BigInt   // Memory limit in MiB
  disk         BigInt   // Disk limit in MiB
  cpu          Float    // CPU limit as percentage (100 = 1 thread/core)

  // Advanced resource settings
  cpuPinning   String?  // Pin to specific CPUs (e.g., "0,1,2,3" or "0-4")
  swap         BigInt   @default(-1) // Swap in MiB: -1 = unlimited, 0 = disabled, >0 = limited
  oomKillDisable Boolean @default(false) // Disable OOM killer

  // Backup settings
  backupLimit  Int      @default(3) // Maximum number of backups

  // Configuration overrides (merged with blueprint)
  config       Json?

  // Server-specific variable values (overrides blueprint defaults)
  // Format: { "MINECRAFT_VERSION": "1.20.4", "SERVER_JARFILE": "server.jar" }
  variables    Json?

  // Selected docker image from blueprint's dockerImages
  // e.g., "ghcr.io/ptero-eggs/yolks:java_21"
  dockerImage  String?

  // Relations
  nodeId       String
  node         Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  blueprintId  String
  blueprint    Blueprint @relation(fields: [blueprintId], references: [id])

  ownerId      String
  owner        User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  allocations Allocation[]

  @@map("servers")
}

enum ServerStatus {
  INSTALLING
  STARTING
  RUNNING
  STOPPING
  STOPPED
  ERROR
}
