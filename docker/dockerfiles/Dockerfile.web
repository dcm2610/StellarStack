# syntax=docker/dockerfile:1.7

# --- Base
FROM node:20-alpine AS base
ENV PNPM_HOME="/pnpm" \
    PATH="/pnpm:$PATH"

RUN apk add --no-cache libc6-compat \
 && corepack enable \
 && pnpm add -g turbo

WORKDIR /repo

# --- Prune
FROM base AS pruner

COPY . .

RUN turbo prune --scope=web --docker \
 && sed -i '/^settings:/a \  injectWorkspacePackages: true' ./out/pnpm-lock.yaml

# --- Install + Build
FROM base AS builder
WORKDIR /app

# Build arguments for Next.js
ARG NEXT_PUBLIC_API_URL
ARG NEXT_PUBLIC_GIT_COMMIT_HASH=unknown

# Set build-time environment variables
ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_GIT_COMMIT_HASH=$NEXT_PUBLIC_GIT_COMMIT_HASH

COPY --from=pruner /repo/out/pnpm-lock.yaml ./pnpm-lock.yaml
COPY --from=pruner /repo/out/pnpm-workspace.yaml ./pnpm-workspace.yaml
COPY --from=pruner /repo/out/json/ ./

RUN pnpm install --frozen-lockfile

COPY --from=pruner /repo/out/full/ ./

RUN pnpm turbo run build --filter=web

# --- Runtime
FROM node:20-alpine AS runner
ENV NODE_ENV=production
ENV PORT=3000
ENV HOSTNAME=::

WORKDIR /app/apps/web

RUN apk add --no-cache libc6-compat \
 && addgroup -g 1001 -S nodejs \
 && adduser -S nodejs -u 1001

# Copy the entire workspace as-is from builder
COPY --from=builder --chown=nodejs:nodejs /app /app

WORKDIR /app/apps/web

USER nodejs

EXPOSE 3000

# Start Next.js production server
CMD ["node_modules/.bin/next", "start"]
